using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public enum MoveMode
{
    Short,
    Long
}

public class TutorialMove : MonoBehaviour
{

    // 컴포넌트 참조
    Rigidbody2D rigid;
    public SpriteRenderer sprite;
    Animator animator;
    public Tutorial tutorial;

    // 설정
    public MoveMode moveMode = MoveMode.Short;
    public Coroutine slideCo = null;

    // 내부값 위치
    public Vector3 CurPos = new Vector3(0, 0, 0);
    public float moveDistance = 1;
    public float speed = 0.1f;

    // Start is called before the first frame update
    void Start()
    {
        rigid = GetComponent<Rigidbody2D>();
        sprite = GetComponentInChildren<SpriteRenderer>();
        animator = GetComponentInChildren<Animator>();
    }

    // Update is called once per frame
    void Update()
    {
        Move();
    }

    IEnumerator Slide(Vector3 _head)
    {
        while(moveMode == MoveMode.Long)
        {
            CurPos += _head * moveDistance * 0.1f;
            yield return null;
        }
    }

    public void StopSlide()
    {
        CurPos = new Vector3(Mathf.Round(CurPos.x), Mathf.Round(CurPos.y), CurPos.z);
    }

    public void Move()
    {
        // 이동
        if (Input.GetKeyDown(KeyCode.LeftArrow))
        {
            // 좌우 반전
            sprite.gameObject.transform.rotation = new Quaternion(0, 0, 0, 0);
            Head(Vector3.left);

        }
        if (Input.GetKeyDown(KeyCode.RightArrow))
        {
            // 좌우 반전
            sprite.gameObject.transform.rotation = new Quaternion(0, 180, 0, 0);
            Head(Vector3.right);
        }
        if (Input.GetKeyDown(KeyCode.UpArrow))
        {
            Head(Vector3.up);
        }
        if (Input.GetKeyDown(KeyCode.DownArrow))
        {
            Head(Vector3.down);
        }
        // 캐릭터 좌표 이동
        transform.localPosition = Vector3.Lerp(transform.localPosition, CurPos, speed);
        if (transform.localPosition == CurPos)
        {
            transform.localPosition = CurPos;
        }
    }

    public void Head(Vector3 _head)
    {
    // 벽 이동불가
    LayerMask mask = LayerMask.GetMask("Wall") | LayerMask.GetMask("Object");

        // 애니메이션
        animator.SetTrigger("Jump");
        // 효과음

        RaycastHit2D rayHit = Physics2D.Raycast(rigid.position, _head, 1 * moveDistance, mask);
        if (!rayHit)
        {
            if (moveMode == MoveMode.Long)
            {
                if(slideCo != null)
                {
                    StopCoroutine(slideCo);
                    StopSlide();
                }
                slideCo = StartCoroutine(Slide(_head));
            }
            else
            {
                CurPos += _head * moveDistance;
            }

            tutorial.Judge(tutorial.time, CurPos.x, CurPos.y);
        }
    }
}
